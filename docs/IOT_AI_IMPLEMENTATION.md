# Применение IoT и AI в АСУ ТП Бетонного завода

## 1. IoT (Интернет вещей) - Архитектура и применение

### 1.1 Схема подключения IoT устройств

```
┌─────────────────────────────────────────────────────────────┐
│                    ПРОИЗВОДСТВЕННАЯ ЗОНА                     │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Силос №1    │  │  Бункер №1   │  │  Бункер №2   │      │
│  │  (Цемент)    │  │  (Песок)     │  │  (Щебень)    │      │
│  │              │  │              │  │              │      │
│  │ [Ультразв.   │  │ [Вибрац.     │  │ [Вибрац.     │      │
│  │  датчик]     │  │  датчик]     │  │  датчик]     │      │
│  │              │  │              │  │              │      │
│  │ [Датчик      │  │ [Датчик      │  │ [Датчик      │      │
│  │  влажности]  │  │  влажности]  │  │  влажности]  │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │               │
│         └─────────────────┼─────────────────┘             │
│                           │                                 │
│                    ┌──────▼──────┐                          │
│                    │   Весы      │                          │
│                    │  (PLC)      │                          │
│                    └──────┬──────┘                          │
│                           │                                 │
│                    ┌──────▼──────┐                          │
│                    │  Смеситель  │                          │
│                    │             │                          │
│                    │ [Датчик     │                          │
│                    │  мощности]  │                          │
│                    │ [Датчик     │                          │
│                    │  вибрации]  │                          │
│                    │ [Датчик     │                          │
│                    │  температуры]│                         │
│                    └──────┬──────┘                          │
└───────────────────────────┼─────────────────────────────────┘
                            │
                            │ (Modbus RTU/TCP, OPC UA)
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    УПРАВЛЕНИЕ И ОБРАБОТКА                     │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │         IoT Gateway (Edge Computing)                 │    │
│  │  - Сбор данных с датчиков                            │    │
│  │  - Предобработка данных                              │    │
│  │  - Локальная обработка (фильтрация, агрегация)       │    │
│  │  - Буферизация при потере связи                      │    │
│  └───────────────────┬───────────────────────────────────┘    │
│                     │                                         │
│                     │ (MQTT / HTTP)                           │
│                     ▼                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │         Backend API (FastAPI)                        │    │
│  │  - Прием данных от IoT Gateway                       │    │
│  │  - Валидация и нормализация                          │    │
│  │  - Сохранение в БД (TimescaleDB)                    │    │
│  │  - Интеграция с AI сервисами                         │    │
│  └───────────────────┬───────────────────────────────────┘    │
│                     │                                         │
│                     │ (WebSocket / REST)                     │
│                     ▼                                         │
│  ┌─────────────────────────────────────────────────────┐    │
│  │         Frontend (React)                             │    │
│  │  - Визуализация в реальном времени                   │    │
│  │  - Алерты и уведомления                              │    │
│  │  - Управление оборудованием                         │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 Типы IoT датчиков и их применение

#### 1.2.1 Весовые контроллеры

**Модели**: Mettler Toledo, Siemens, Schneider Electric

**Технические характеристики**:
- Точность: ±0.1% от полной шкалы
- Диапазон: 0-5000 кг (цемент), 0-10000 кг (инертные)
- Интерфейс: Modbus RTU/TCP, 4-20mA
- Частота опроса: 10 Гц

**Применение**:
- Контроль веса каждого компонента при дозировании
- Автоматическая остановка при достижении заданного веса
- Логирование всех взвешиваний для анализа

**Интеграция**:
```python
# Пример чтения данных с весов
def read_scale_weight(scale_address):
    # Modbus запрос к весам
    weight = modbus_client.read_holding_registers(
        scale_address, 
        register=0, 
        count=2
    )
    return weight / 10.0  # Конвертация в кг
```

#### 1.2.2 Датчики уровня (силосы, бункеры)

**Типы**:
- **Ультразвуковые** (для силосов цемента)
  - Диапазон: 0-30 м
  - Точность: ±0.1 м
  - Протокол: 4-20mA, Modbus
  
- **Вибрационные** (для бункеров песка/щебня)
  - Диапазон: 0-10 м
  - Точность: ±0.05 м
  - Протокол: Digital I/O, Modbus

**Применение**:
- Мониторинг остатков сырья в реальном времени
- Автоматическое предупреждение о низких остатках
- Расчет массы по формуле: `Масса = Площадь * Высота * Плотность`

**Пример данных**:
```json
{
  "silo_id": 1,
  "material_type": "cement",
  "level_m": 8.5,
  "level_percent": 85.0,
  "mass_kg": 85000,
  "timestamp": "2024-11-18T14:30:00Z"
}
```

#### 1.2.3 Датчики влажности

**Модели**: Vaisala, Rotronic

**Технические характеристики**:
- Диапазон: 0-100% относительной влажности
- Точность: ±0.5%
- Температура работы: -40°C до +80°C
- Интерфейс: Modbus, 4-20mA

**Расположение**:
- В бункере песка (на высоте 1/3 от дна)
- В бункере щебня (на высоте 1/3 от дна)
- Измерение каждые 5 минут

**Применение**:
- Автоматическая коррекция количества воды в рецепте
- Формула коррекции:
  ```
  Вода_скорректированная = Вода_рецепт 
    - (Влажность_песка * Песок_кг / 100)
    - (Влажность_щебня * Щебень_кг / 100)
  ```

#### 1.2.4 Датчики температуры

**Типы**:
- **Термопары** (в смесителе)
  - Диапазон: -50°C до +200°C
  - Точность: ±1°C
  
- **Термометры сопротивления** (окружающая среда)
  - Диапазон: -40°C до +60°C
  - Точность: ±0.5°C

**Применение**:
- Контроль температуры смеси (влияет на время схватывания)
- Коррекция времени перемешивания зимой/летом
- Предупреждение о замерзании воды зимой

#### 1.2.5 Датчики вибрации и состояния оборудования

**Модели**: SKF, Bently Nevada

**Параметры**:
- Ускорение: 0-100 м/с²
- Частота: 0-10 кГц
- Температура подшипников: -40°C до +150°C

**Применение**:
- Мониторинг состояния подшипников смесителя
- Обнаружение дисбаланса ротора
- Предсказательное обслуживание (Predictive Maintenance)

**AI анализ**:
- Обучение модели на исторических данных
- Обнаружение аномалий в спектре вибрации
- Прогноз остаточного ресурса оборудования

#### 1.2.6 GPS трекеры (бетоновозы)

**Модели**: Teltonika, Queclink

**Функции**:
- GPS позиционирование (точность ±3 м)
- GPRS/4G передача данных
- Акселерометр (обнаружение движения)
- Датчик уровня топлива

**Применение**:
- Отслеживание местоположения транспорта в реальном времени
- Расчет времени прибытия на объект
- Контроль маршрута
- Анализ эффективности доставки

### 1.3 Протоколы связи IoT

#### Modbus RTU/TCP
- **Использование**: Весовые контроллеры, PLC
- **Скорость**: 9600-115200 бод (RTU), Ethernet (TCP)
- **Преимущества**: Стандартный протокол, широкая поддержка

#### OPC UA
- **Использование**: Промышленные контроллеры (Siemens, Schneider)
- **Преимущества**: Безопасность, кроссплатформенность
- **Структура данных**: Иерархическая модель

#### MQTT
- **Использование**: Легковесные IoT датчики
- **Преимущества**: Низкое энергопотребление, pub/sub модель
- **Брокер**: Mosquitto, HiveMQ

#### HTTP/REST
- **Использование**: Интеграция с внешними системами
- **Преимущества**: Простота, универсальность

### 1.4 Edge Computing (Пограничные вычисления)

**Зачем нужно**:
- Обработка данных на месте (низкая задержка)
- Работа при потере связи с центральным сервером
- Снижение нагрузки на сеть

**Функции Edge Gateway**:
- Фильтрация данных (удаление шумов)
- Агрегация (усреднение, минимум/максимум)
- Локальная обработка (простые алгоритмы)
- Буферизация при потере связи
- Критические команды (остановка оборудования)

---

## 2. AI (Искусственный интеллект) - Применение и модели

### 2.1 Предиктивная аналитика качества бетона

#### Задача
Предсказать прочность бетона на 7 и 28 дней на основе параметров производства.

#### Модель
**Random Forest Regressor** или **Neural Network**

**Входные признаки** (features):
```python
features = [
    'cement_kg',           # Количество цемента (кг/м³)
    'sand_kg',             # Количество песка (кг/м³)
    'gravel_kg',            # Количество щебня (кг/м³)
    'water_kg',             # Количество воды (кг/м³)
    'additive1_kg',         # Добавка 1 (кг/м³)
    'additive2_kg',         # Добавка 2 (кг/м³)
    'water_cement_ratio',   # Водоцементное отношение
    'sand_cement_ratio',    # Отношение песок/цемент
    'moisture_sand_pct',    # Влажность песка (%)
    'moisture_gravel_pct',  # Влажность щебня (%)
    'mixing_time_sec',      # Время перемешивания (сек)
    'temperature_c',        # Температура смеси (°C)
    'deviation_cement_pct', # Отклонение цемента (%)
    'deviation_water_pct',  # Отклонение воды (%)
    'batch_volume_m3',      # Объем партии (м³)
]
```

**Целевая переменная**:
- `strength_7d_mpa` - Прочность через 7 дней (МПа)
- `strength_28d_mpa` - Прочность через 28 дней (МПа)

**Пример кода**:
```python
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
import pandas as pd

# Загрузка исторических данных
data = load_historical_batches()  # 1000+ партий

# Подготовка данных
X = data[features]
y_7d = data['strength_7d_mpa']
y_28d = data['strength_28d_mpa']

# Обучение модели для 7 дней
X_train, X_test, y_train, y_test = train_test_split(X, y_7d, test_size=0.2)
model_7d = RandomForestRegressor(n_estimators=100, max_depth=10)
model_7d.fit(X_train, y_train)

# Обучение модели для 28 дней
X_train, X_test, y_train, y_test = train_test_split(X, y_28d, test_size=0.2)
model_28d = RandomForestRegressor(n_estimators=100, max_depth=10)
model_28d.fit(X_train, y_train)

# Предсказание для новой партии
new_batch_features = extract_features(current_batch)
predicted_7d = model_7d.predict([new_batch_features])[0]
predicted_28d = model_28d.predict([new_batch_features])[0]
```

**Точность модели**:
- R² score: 0.85-0.92
- MAE (Mean Absolute Error): ±2-3 МПа

**Применение в интерфейсе**:
- При создании партии показывать предсказанную прочность
- Предупреждение, если предсказанная прочность < требуемой
- Рекомендации по корректировке рецепта

### 2.2 Автоматическая коррекция воды (AI)

#### Задача
Автоматически корректировать количество воды с учетом влажности инертных материалов.

#### Алгоритм

**Базовая формула**:
```python
def calculate_water_correction(recipe, moisture_sand, moisture_gravel):
    # Базовая коррекция
    water_correction = (
        (moisture_sand * recipe.sand_kg / 100) +
        (moisture_gravel * recipe.gravel_kg / 100)
    )
    
    corrected_water = recipe.water_kg - water_correction
    
    return corrected_water
```

**AI улучшение**:
```python
# Обучение модели на исторических данных
# Вход: влажность, отклонения прочности
# Выход: дополнительная коррекция

from sklearn.ensemble import GradientBoostingRegressor

# Модель учится на том, какие коррекции приводили к лучшим результатам
ai_correction_model = GradientBoostingRegressor()
ai_correction_model.fit(
    X=[moisture_data, historical_deviations],
    y=[optimal_water_corrections]
)

# Применение
base_correction = calculate_water_correction(...)
ai_additional = ai_correction_model.predict([current_moisture])[0]
final_water = recipe.water_kg - base_correction + ai_additional
```

### 2.3 Предсказательное обслуживание (Predictive Maintenance)

#### Задача
Предсказать отказ оборудования до его возникновения.

#### Модель
**LSTM (Long Short-Term Memory)** для временных рядов + **Isolation Forest** для обнаружения аномалий

**Входные данные** (временные ряды):
- Вибрация (спектр частот)
- Температура подшипников
- Энергопотребление
- Ток двигателя

**Пример**:
```python
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense
from sklearn.ensemble import IsolationForest

# Подготовка данных (окна по 100 измерений)
def create_sequences(data, window_size=100):
    X, y = [], []
    for i in range(len(data) - window_size):
        X.append(data[i:i+window_size])
        y.append(data[i+window_size])  # Следующее значение
    return np.array(X), np.array(y)

# Обучение LSTM
model = Sequential([
    LSTM(50, return_sequences=True, input_shape=(100, 4)),
    LSTM(50),
    Dense(1)
])
model.compile(optimizer='adam', loss='mse')
model.fit(X_train, y_train, epochs=50)

# Обнаружение аномалий
anomaly_detector = IsolationForest(contamination=0.1)
anomaly_detector.fit(vibration_data)

# Предсказание
predicted_value = model.predict(current_window)
if anomaly_detector.predict([current_features]) == -1:
    alert("Обнаружена аномалия в работе оборудования!")
```

**Выходные данные**:
- Вероятность отказа в ближайшие 7/30 дней
- Рекомендуемое время обслуживания
- Критичность (низкая/средняя/высокая)

### 2.4 Оптимизация рецептур

#### Задача
Найти оптимальный состав бетона для заданной прочности с минимальной стоимостью.

#### Модель
**Genetic Algorithm** (Генетический алгоритм) или **Bayesian Optimization**

**Целевая функция**:
```python
def objective_function(recipe):
    # Стоимость компонентов
    cost = (
        recipe.cement_kg * cement_price +
        recipe.sand_kg * sand_price +
        recipe.gravel_kg * gravel_price +
        recipe.water_kg * water_price +
        recipe.additive1_kg * additive1_price
    )
    
    # Предсказанная прочность
    predicted_strength = strength_model.predict([recipe_features])[0]
    
    # Штраф за несоответствие требуемой прочности
    strength_penalty = abs(predicted_strength - target_strength) * 1000
    
    return cost + strength_penalty
```

**Ограничения**:
- Минимальная прочность: >= требуемой
- Максимальная прочность: <= требуемой + 10 МПа (чтобы не переплачивать)
- Соответствие ГОСТ
- Доступность сырья

**Результат**: Оптимизированный рецепт с минимальной стоимостью

### 2.5 Обнаружение аномалий в реальном времени

#### Задача
Обнаружить отклонения в процессе производства в реальном времени.

#### Модель
**Isolation Forest** или **Autoencoder**

**Мониторинг параметров**:
- Отклонения дозирования
- Энергопотребление смесителя
- Время цикла
- Температура смеси

**Пример**:
```python
from sklearn.ensemble import IsolationForest
import numpy as np

# Обучение на нормальных данных
normal_data = load_normal_production_data()
anomaly_detector = IsolationForest(contamination=0.05)
anomaly_detector.fit(normal_data)

# Проверка текущей партии
current_features = [
    deviation_cement,
    deviation_water,
    energy_consumption,
    cycle_time,
    temperature
]

is_anomaly = anomaly_detector.predict([current_features])[0] == -1

if is_anomaly:
    anomaly_score = anomaly_detector.score_samples([current_features])[0]
    if anomaly_score < -0.5:
        alert("Критическая аномалия обнаружена!")
        stop_production()
```

### 2.6 Прогнозирование спроса

#### Задача
Предсказать спрос на бетон для планирования производства и закупок.

#### Модель
**Prophet** (Facebook) или **ARIMA** для временных рядов

**Факторы**:
- Сезонность (строительный сезон)
- День недели
- Погодные условия
- Экономические индикаторы
- История заказов

**Пример**:
```python
from prophet import Prophet
import pandas as pd

# Подготовка данных
df = pd.DataFrame({
    'ds': dates,  # Даты
    'y': orders_volume,  # Объем заказов
    'temperature': temperatures,  # Погода
    'is_weekend': is_weekends,  # Выходные
})

# Обучение модели
model = Prophet()
model.add_regressor('temperature')
model.add_regressor('is_weekend')
model.fit(df)

# Прогноз на 30 дней вперед
future = model.make_future_dataframe(periods=30)
forecast = model.predict(future)
```

**Применение**:
- Планирование закупок цемента на месяц вперед
- Оптимизация складских запасов
- Планирование производства

---

## 3. Интеграция IoT и AI в систему

### 3.1 Архитектура интеграции

```
IoT Датчики → Edge Gateway → Backend API → AI Service → Frontend
                ↓              ↓            ↓
            Локальная      TimescaleDB   ML Models
            обработка      (История)     (Предсказания)
```

### 3.2 Поток данных в реальном времени

1. **Сбор данных** (IoT):
   - Датчики отправляют данные каждые 1-5 секунд
   - Edge Gateway агрегирует и фильтрует

2. **Обработка** (Backend):
   - Валидация данных
   - Сохранение в TimescaleDB
   - Отправка в AI Service

3. **AI анализ**:
   - Предсказания в реальном времени
   - Обнаружение аномалий
   - Генерация рекомендаций

4. **Визуализация** (Frontend):
   - WebSocket для обновлений в реальном времени
   - Отображение предсказаний
   - Алерты и уведомления

### 3.3 Примеры использования в интерфейсе

#### При создании партии:
- AI показывает предсказанную прочность
- Рекомендации по оптимизации рецепта

#### Во время дозирования:
- IoT данные в реальном времени
- AI коррекция воды автоматически
- Предупреждения при отклонениях

#### После перемешивания:
- AI оценка качества на основе параметров
- Рекомендации для лаборатории

#### На дашборде:
- Прогноз производства на день
- Предсказания отказов оборудования
- Оптимизированные рекомендации

---

## 4. Экономический эффект

### 4.1 Снижение брака
- **Без AI**: 3-5% брака
- **С AI**: <1% брака
- **Экономия**: ~2-4% от объема производства

### 4.2 Оптимизация рецептур
- **Экономия на материалах**: 5-10%
- **При объеме 1000 м³/день**: 50-100 м³ экономии

### 4.3 Предсказательное обслуживание
- **Снижение простоев**: 30-40%
- **Оптимизация расходов на обслуживание**: 20-30%

### 4.4 Повышение точности
- **Точность дозирования**: >98% в пределах допусков
- **Снижение отклонений**: на 50%

---

## 5. План внедрения

### Фаза 1: IoT инфраструктура (1-2 месяца)
- Установка датчиков
- Настройка Edge Gateway
- Интеграция с PLC
- Тестирование связи

### Фаза 2: Сбор данных (2-3 месяца)
- Накопление исторических данных
- Валидация качества данных
- Настройка мониторинга

### Фаза 3: Разработка AI моделей (2-3 месяца)
- Подготовка данных
- Обучение моделей
- Валидация и тестирование
- Деплой моделей

### Фаза 4: Интеграция в систему (1 месяц)
- Интеграция AI сервисов
- Обновление интерфейса
- Обучение персонала

### Фаза 5: Оптимизация (постоянно)
- Улучшение моделей
- Добавление новых функций
- Анализ эффективности

